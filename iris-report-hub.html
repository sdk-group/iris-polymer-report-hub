<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iris-polymer-importer/iris-importer.html">
<link rel="import" href="../iris-polymer-date-picker/iris-date-picker.html">
<link rel="import" href="../iris-polymer-styles/iris-mydocs-styles.html">


<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="iris-stepper.html">
<link rel="import" href="iris-template-picker.html">
<link rel="import" href="report-hub-temp.html">
<link rel="import" href="iris-time-picker.html">

<dom-module id="iris-report-hub">
  <template>
    <style>
      :host {
        display: block;
      }
      
      paper-material {
        padding: 20px 10px;
      }
      
      #pages {
        margin-top: 20px;
      }
      
      tr {
        border-bottom: 1px solid;
      }
      
      td {
        text-align: center;
      }
      
      table {
        border-collapse: collapse;
        white-space: nowrap;
      }
    </style>

    <iris-workstation id="reporter"></iris-workstation>
    <paper-material id="stepper" elevation="1">
      <iris-stepper steps="[[steps]]" states="{{states}}" selected="{{selectedPage}}"></iris-stepper>
    </paper-material>
    <iron-pages selected="[[selectedPage]]">

      <div id="template-selector">
        <iris-template-picker entities="[[entities]]" template="{{selectedTemplate}}"></iris-template-picker>
      </div>

      <div id="template-office">
        <paper-checkbox>Выделить все</paper-checkbox>
        <template is="dom-repeat" items="[[offices]]">
          <paper-checkbox on-change="selectedOffice">[[item.label]]</paper-checkbox>
        </template>
      </div>

      <div id="intreval-picker">
        <iris-time-picker vertical-align="top" hours="{{startHours}}" minutes="{{startMinutes}}"></iris-time-picker>
        <iris-time-picker vertical-align="top" hours="{{endHours}}" minutes="{{endMinutes}}"></iris-time-picker>
        <iris-date-picker selected="{{startDate}}"></iris-date-picker>
        <iris-date-picker selected="{{endDate}}"></iris-date-picker>
      </div>

      <div id="table">
        <table>
          <tr>
            <th>
              Парам
            </th>
            <template is="dom-repeat" items="[[tableKeys]]" as="cellindex">
              <th>
                [[translateKey(cellindex)]]
              </th>
            </template>
          </tr>
          <template is="dom-repeat" items="[[getRows(tableData)]]" as="rowindex">
            <tr>
              <td>
                [[rowindex]]
              </td>
              <template is="dom-repeat" items="[[tableKeys]]" as="cellindex">
                <td>
                  [[getCell(rowindex,cellindex)]]
                </td>
              </template>
            </tr>
          </template>
        </table>
      </div>
    </iron-pages>

    <paper-button>Назад</paper-button>
    <paper-button disabled$="[[canNext(selectedPage,selectedTemplate,selectedOffices.length,startDate,endDate)]]" on-tap="nextPage">Далее</paper-button>
  </template>
  <script>
    'use strict'
    let table_draft = {
      interval: ["2016-04-07", "2016-04-14"],
      entity: "Ticket",
      interval_field: "dedicated_date",
      department: ['department-1', 'department-2'],
      params: [{
        label: "Param 1",
        key: "id",
        group: [{
          method: 'month',
          field: 'booking_date'
        }, {
          method: 'month-day',
          field: 'booking_date'
        }, {
          method: '5min',
          field: 'booking_date'
        }, {
          method: 'enum',
          field: "org_destination"
        }],
        aggregator: "count", //String const
        filter: [],
        meta: false
      }]
    };

    Polymer({
      is: 'iris-report-hub',
      ready() {
        this.steps = ['Шаблон отчета', 'Офис', 'Временной интервал', 'Результат'];
        this.states = Array(this.steps.length);
        this.selectedPage = 0;
        this.entities = ReportHubData.entities;
        this.offices = ReportHubData.offices;
        this.startDate = false;
        this.endDate = false;
        this.selectedOffices = [];
      },
      nextPage() {
        this.states[this.selectedPage] = true;
        this.selectedPage += 1;
        if ((this.selectedPage + 1) == this.steps.length) {
          console.log('request server');
          let interval = [this.startDate, this.endDate];
          table_draft.interval = interval;
          console.log(interval);
          this.$.reporter.getTable({
            table: table_draft
          }).then((data) => {
            console.log(data);
            let keys = _.sortBy(_.union(_.flatMap(data, _.keys)));

            this.set('tableKeys', keys);
            this.set('tableData', data);
          });
        }
      },
      selectedOffice(e) {
        let checked = e.target.checked;
        let id = e.model.item.id;

        if (checked) {
          this.push('selectedOffices', id);
        } else {
          this.set('selectedOffices', _.filter(this.selectedOffices, d => d != id));
        }
      },
      canNext(page, template_id, length, startDate, endDate) {
        console.log(page, template_id, length);
        switch (page) {
          case 0:
            return !template_id;
            break;
          case 1:
            return !length;
            break;
          case 2:
            return !(startDate && endDate);
            break;
          default:
            return true;
        }
      },
      getRows(d) {
        return _.keys(d);
      },
      getColls(ri) {
        return _.keys(this.tableData[ri])
      },
      getCell(rowindex, cell) {
        return _.get(this.tableData, [rowindex, cell]);
      },
      translateKey(key) {
        return parseInt(key.split('::')[2])
      }
    });
  </script>
</dom-module>
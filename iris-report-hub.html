<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iris-polymer-importer/iris-importer.html">
<link rel="import" href="../iris-polymer-date-picker/iris-date-picker.html">
<link rel="import" href="../iris-polymer-styles/iris-mydocs-styles.html">
<link rel="import" href="../iris-polymer-table/iris-table.html">

<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="iris-stepper.html">
<link rel="import" href="iris-template-picker.html">
<link rel="import" href="report-hub-temp.html">
<link rel="import" href="iris-time-picker.html">
<link rel="import" href="report-nested-table.html">
<link rel="import" href="report-group-maker.html">

<dom-module id="iris-report-hub">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
      }

      iron-pages {
        @apply(--layout-vertical);
        @apply(--layout-flex-auto);
        height: 0;
        overflow: auto;
      }

      paper-material {
        padding: 20px 10px;
      }

      iron-pages paper-material {
        @apply(--layout-vertical);
        @apply(--layout-flex-auto);
      }

      iron-pages > div {
        padding: 1px 3px;
        height: 100%;
        @apply(--layout-vertical);
        @apply(--layout-flex-auto);
      }

      iris-template-picker {
        @apply(--layout-flex-auto);
      }

      #pages {
        margin-top: 20px;
      }

      #stepper {
        margin: 0 3px;
        box-shadow: 0 -1px 2px 0 rgba(0, 0, 0, 0.14), 0 -1px 5px 0 rgba(0, 0, 0, 0.12), 0 2px 1px -2px rgba(0, 0, 0, 0.2);
      }

      #interval-picker {
        @apply(--layout-vertical);
        @apply(--layout-around-justified);
      }

      #calendar-wrapper {
        @apply(--layout-horizontal);
        @apply(--layout-around-justified);
      }

      paper-checkbox {
        display: block;
      }

      #template-selector paper-material {
        padding: 0;
      }

      #action-buttons {
        margin: 0 3px;
        @apply(--layout);
        @apply(--layout-end-justified);
      }

      paper-card {
        border-width: 0;
      }

      iris-time-picker {
        text-align: center;
      }
    </style>

    <iris-workstation id="reporter"></iris-workstation>
    <paper-material id="stepper" elevation="1">
      <iris-stepper steps="[[steps]]" states="{{states}}" selected="{{selectedPage}}"></iris-stepper>
    </paper-material>

    <iron-pages selected="[[selectedPage]]">

      <div id="template-selector">
        <paper-material elevation="1">
          <iris-template-picker entities="[[entities]]" template="{{selectedTemplate}}"></iris-template-picker>
        </paper-material>
      </div>

      <div id="group-selector">
        <paper-material elevation="1">
          <report-group-maker groups="{{groups}}"></report-group-maker>
        </paper-material>
      </div>

      <div id="template-office">
        <paper-material elevation="1">
          <iris-table data="[[offices]]" multiselect fields-model="[[tableModel]]" selected="{{selectedOffices}}"></iris-table>
        </paper-material>
      </div>

      <div id="interval-picker">
        <div id="calendar-wrapper">
          <paper-card id="start-time" heading="От">
            <!--<iris-time-picker vertical-align="top" horizontal-align="right" hours="{{startHours}}" minutes="{{startMinutes}}"></iris-time-picker>-->
            <iris-date-picker selected="{{startDate}}"></iris-date-picker>
          </paper-card>

          <paper-card id="end-time" heading="До">
            <!--<iris-time-picker vertical-align="top" hours="{{endHours}}" minutes="{{endMinutes}}"></iris-time-picker>-->
            <iris-date-picker selected="{{endDate}}"></iris-date-picker>
          </paper-card>
        </div>
      </div>

      <div id="table">
        <report-nested-table map="[[tableMap]]" data="[[tableData]]" rows="[[rows]]"></report-nested-table>
      </div>
    </iron-pages>
    <paper-material id="action-buttons" elevation="1">
      <paper-button>Назад</paper-button>
      <paper-button disabled$="[[canNext(selectedPage,selectedTemplate,selectedOffices.length,startDate,endDate,groups)]]" on-tap="nextPage">Далее</paper-button>
    </paper-material>
  </template>
  <script>
    'use strict'
    const group_delimiter = '::';

    let table_draft = {
      interval: [
        "2016-04-07", "2016-04-14"
      ],
      entity: "Ticket",
      interval_field: "dedicated_date",
      department: [
        'department-1', 'department-2'
      ],
      group: [{
        method: 'enum',
        field: "org_destination"
      }, {
        method: 'month',
        field: 'booking_date'
      }, {
        method: 'week-day',
        field: 'booking_date'
      }],
      params: [{
        label: "Param 1",
        key: "id",
        aggregator: "count", //String const
        filter: [],
        meta: false
      }]
    };

    Polymer({
      is: 'iris-report-hub',
      ready() {
        this.steps = ['Шаблон отчета', 'Группировка', 'Офис', 'Временной интервал', 'Результат'];
        this.states = Array(this.steps.length);
        this.selectedPage = 0;

        this.endHours = '23';
        this.endMinutes = '59';

        this.entities = ReportHubData.entities;
        this.offices = ReportHubData.offices;
        this.startDate = false;
        this.endDate = false;
        this.selectedOffices = [];
        this.tableModel = [{
          field: 'label',
          label: "Офис"
        }];
      },
      checkAll() {
        console.log('All');
      },
      nextPage() {
        this.states[this.selectedPage] = true;
        this.selectedPage += 1;
        if ((this.selectedPage + 1) == this.steps.length) {
          console.log('request server');
          let interval = [this.startDate, this.endDate];
          let template = this.selectedTemplate;

          template.department = _.map(this.selectedOffices, 'id');
          template.interval = interval;
          template.group = this.groups;

          let header_labels = _.map(template.group, 'method').join(group_delimiter);
          let labels = _.map(template.params, 'label');

          this.$.reporter.getTable({
            table: template
          }).then((data) => {
            console.log('response', data);
            let keys = _.sortBy(_.keys(data));
            _.set(data, header_labels, labels);

            let map = {};
            _.set(map, _.map(template.group, 'method'), true, Object);

            _.forEach(keys, key => {
              let parts = key.split(group_delimiter);
              _.setWith(map, parts, true, Object);
            });

            let rows = {
              keys: _.keys(template.params)
            };

            this.set('tableData', data);
            this.set('rows', rows);
            this.set('tableMap', map);
          });
        }
      },
      canNext(page, template_id, length, startDate, endDate, groups) {
        console.log(startDate, endDate);
        switch (page) {
          case 0:
            return !template_id;
            break;
          case 2:
            return !length;
            break;
          case 3:
            return !(startDate && endDate && endDate >= startDate);
            break;
          default:
            return false;
        }
      },
      getRows(d) {
        return _.keys(d);
      },
      getColls(ri) {
        return _.keys(this.tableData[ri])
      },
      getCell(rowindex, cell) {
        return _.get(this.tableData, [rowindex, cell]);
      },
      translateKey(key) {
        return parseInt(key.split('::')[2])
      }
    });
  </script>
</dom-module>
pt>
</dom-module>

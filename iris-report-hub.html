<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iris-polymer-importer/iris-importer.html">
<link rel="import" href="../iris-polymer-date-picker/iris-date-picker.html">
<link rel="import" href="../iris-polymer-styles/iris-mydocs-styles.html">


<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="iris-stepper.html">
<link rel="import" href="iris-template-picker.html">
<link rel="import" href="report-hub-temp.html">
<link rel="import" href="iris-time-picker.html">
<link rel="import" href="report-nested-table.html">
<link rel="import" href="report-group-maker.html">

<dom-module id="iris-report-hub">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-material {
        padding: 20px 10px;
      }

      #pages {
        margin-top: 20px;
      }
    </style>

    <iris-workstation id="reporter"></iris-workstation>
    <paper-material id="stepper" elevation="1">
      <iris-stepper steps="[[steps]]" states="{{states}}" selected="{{selectedPage}}"></iris-stepper>
    </paper-material>

    <iron-pages selected="[[selectedPage]]">

      <div id="template-selector">
        <iris-template-picker entities="[[entities]]" template="{{selectedTemplate}}"></iris-template-picker>
      </div>

      <div id="group-selector">
        <report-group-maker groups="{{groups}}"></report-group-maker>
      </div>

      <div id="template-office">
        <paper-checkbox>Выделить все</paper-checkbox>
        <template is="dom-repeat" items="[[offices]]">
          <paper-checkbox on-change="selectedOffice">[[item.label]]</paper-checkbox>
        </template>
      </div>

      <div id="intreval-picker">
        <iris-time-picker vertical-align="top" hours="{{startHours}}" minutes="{{startMinutes}}"></iris-time-picker>
        <iris-time-picker vertical-align="top" hours="{{endHours}}" minutes="{{endMinutes}}"></iris-time-picker>
        <iris-date-picker selected="{{startDate}}"></iris-date-picker>
        <iris-date-picker selected="{{endDate}}"></iris-date-picker>
      </div>

      <div id="table">
        <report-nested-table map="[[tableMap]]" data="[[tableData]]" rows="[[rows]]"></report-nested-table>
      </div>
    </iron-pages>

    <paper-button>Назад</paper-button>
    <paper-button disabled$="[[canNext(selectedPage,selectedTemplate,selectedOffices.length,startDate,endDate,groups)]]" on-tap="nextPage">Далее</paper-button>
  </template>
  <script>
    'use strict'
    let table_draft = {
      interval: ["2016-04-07", "2016-04-14"],
      entity: "Ticket",
      interval_field: "dedicated_date",
      department: ['department-1', 'department-2'],
      group: [{
        method: 'enum',
        field: "org_destination"
      }, {
        method: 'month',
        field: 'booking_date'
      }, {
        method: 'week-day',
        field: 'booking_date'
      }],
      params: [{
        label: "Param 1",
        key: "id",
        aggregator: "count", //String const
        filter: [],
        meta: false
      }]
    };

    Polymer({
      is: 'iris-report-hub',
      ready() {
        this.steps = ['Шаблон отчета', 'Группировка', 'Офис', 'Временной интервал', 'Результат'];
        this.states = Array(this.steps.length);
        this.selectedPage = 0;
        this.entities = ReportHubData.entities;
        this.offices = ReportHubData.offices;
        this.startDate = false;
        this.endDate = false;
        this.selectedOffices = [];
      },
      nextPage() {
        this.states[this.selectedPage] = true;
        this.selectedPage += 1;
        if ((this.selectedPage + 1) == this.steps.length) {
          console.log('request server');
          let interval = [this.startDate, this.endDate];
          let template = this.selectedTemplate.template;

          template.department = this.selectedOffices;
          template.interval = interval;

          this.$.reporter.getTable({
            table: template
          }).then((data) => {
            console.log(data);
            let keys = _.sortBy(_.keys(data));

            this.set('tableData', data);
            this.set('rows', _.keys(template.params));
            console.log(this.rows);
            let map = {};
            _.forEach(keys, key => {
              let parts = key.split('::');
              _.setWith(map, parts, true, Object);
            });
            this.set('tableMap', map);
            console.log(map);
          });
        }
      },
      selectedOffice(e) {
        let checked = e.target.checked;
        let id = e.model.item.id;

        if (checked) {
          this.push('selectedOffices', id);
        } else {
          this.set('selectedOffices', _.filter(this.selectedOffices, d => d != id));
        }
      },
      canNext(page, template_id, length, startDate, endDate, groups) {

        switch (page) {
          case 0:
            return !template_id;
            break;
          case 2:
            return !length;
            break;
          case 3:
            return !(startDate && endDate);
            break;
          default:
            return true;
        }
      },
      getRows(d) {
        return _.keys(d);
      },
      getColls(ri) {
        return _.keys(this.tableData[ri])
      },
      getCell(rowindex, cell) {
        return _.get(this.tableData, [rowindex, cell]);
      },
      translateKey(key) {
        return parseInt(key.split('::')[2])
      }
    });
  </script>
</dom-module>

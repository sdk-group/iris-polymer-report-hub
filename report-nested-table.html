<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="iris-report-translation-behavior.html">

<dom-module id="report-nested-table">
  <template>
    <style>
      :host {
        display: block;
      }

      td {
        text-align: center;
        padding: 0;
      }

      th {
        border-top: 1px solid;
        border-left: 1px solid;
      }

      table {
        border-collapse: collapse;
        width: 100%;
        white-space: nowrap;
      }

      .data-cell {
        border: 1px solid;
      }
    </style>

    <table>
      <tr>
        <template is="dom-repeat" items="[[keys]]">
          <th>
            [[translate(entityName,item)]]
          </th>
        </template>
      </tr>

      <template is="dom-if" if="[[hasSubmap(map,keys)]]">
        <tr>
          <template is="dom-repeat" items="[[keys]]">
            <td>
              <report-nested-table entity-name="[[entityName]]" data="[[data]]" rows="[[rows]]" map="[[getSubMap(map,item)]]" path="[[computePath(item)]]"></report-nested-table>
            </td>
          </template>
        </tr>
      </template>

      <template is="dom-if" if="[[!hasSubmap(map,keys)]]">
        <template is="dom-repeat" items="[[rows.keys]]" as="row">
          <tr>
            <template is="dom-repeat" items="[[keys]]">
              <td class="data-cell">
                [[getData(row,item)]]
              </td>
            </template>
          </tr>
        </template>
      </template>
    </table>
  </template>
  <script>
    Polymer({
      is: 'report-nested-table',
      behaviors: [window.IrisBehaviors.TranslationBehvior],
      properties: {
        entityName: String,
        data: Object,
        map: Object,
        keys: {
          type: Array,
          computed: '_getKeys(map)'
        },
        path: {
          type: Array,
          value: []
        },
        rows: {
          type: Object,
          value: {}
        }
      },

      computePath(item) {
        return _.union(this.path, [item]);
      },
      _getKeys(map) {
        return _.keys(map);
      },
      getSubMap(map, item) {
        return map[item];
      },
      hasSubmap(map, keys) {
        return _.isObject(map[keys[0]])
      },
      getData(row, item) {
        let key = this.path.length ? this.path.join('::') + '::' + item : item;
        let data = _.get(this.data, [key, row]);
        return data === undefined ? '-' : data;
      }
    });
  </script>
</dom-module>
